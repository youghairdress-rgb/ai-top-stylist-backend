<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIトップスタイリスト診断</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* カスタムスタイル */
        :root {
            --brand-color: #0ABAB5; /* ティファニーブルー系 */
            --background-color: #F0FEFD;
            --text-color: #333;
            --card-bg: #ffffff;
            --primary-button-bg: #0ABAB5;
            --secondary-button-bg: #E6F8F7;
        }
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .main-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--background-color);
        }
        .card {
            background-color: var(--card-bg);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: var(--primary-button-bg);
            color: white;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 9999px;
            transition: all 0.3s;
            display: block;
            width: 100%;
            text-align: center;
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: var(--secondary-button-bg);
            color: var(--brand-color);
            border: 1px solid var(--brand-color);
        }
        .btn-disabled {
            background-color: #ccc !important;
            cursor: not-allowed !important;
            transform: none !important;
            opacity: 0.7 !important;
        }
        .page {
            display: none; /* 初期状態は非表示 */
        }
        .page.active {
            display: block; /* アクティブなページのみ表示 */
        }
        .file-upload-box {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-upload-box:hover {
            border-color: var(--brand-color);
            background-color: var(--background-color);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--brand-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="main-container p-4">

        <!-- ===== Page 1: Start ===== -->
        <div id="page-start" class="page active flex flex-col items-center justify-center min-h-[80vh] text-center">
            <div class="card w-full">
                <div class="w-24 h-24 bg-teal-100 rounded-full mx-auto flex items-center justify-center mb-6">
                    <span class="text-teal-500 text-3xl font-bold">LOGO</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">YHD AI Diagnosis</h1>
                <p class="text-teal-600 font-semibold mb-6">YHD × AI 『似合わせ』診断</p>
                <p class="text-gray-600 mb-8">お客様の『似合う』を実現するために<br>AIが分析し、最適なアドバイスを伝えます！</p>
                <button onclick="changePage('page-profile')" class="btn-primary">診断を始める</button>
            </div>
        </div>

        <!-- ===== Page 2: Profile Input ===== -->
        <div id="page-profile" class="page">
             <div class="card w-full">
                <h2 class="text-xl font-bold text-center mb-6">プロフィール入力</h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">LINEユーザーID</label>
                    <input type="text" id="user-id" value="(LIFFから自動取得)" class="w-full p-2 bg-gray-100 border rounded-md" readonly>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">お名前</label>
                    <input type="text" id="user-name" value="(LIFFから自動取得)" class="w-full p-2 border rounded-md bg-gray-100" readonly>
                </div>
                <div class="mb-6">
                     <label class="block text-sm font-medium text-gray-700 mb-2">性別</label>
                     <div class="flex justify-around">
                         <label class="flex items-center"><input type="radio" name="gender" value="female" class="mr-2" checked>女性</label>
                         <label class="flex items-center"><input type="radio" name="gender" value="male" class="mr-2">男性</label>
                         <label class="flex items-center"><input type="radio" name="gender" value="other" class="mr-2">その他</label>
                     </div>
                </div>
                <button onclick="changePage('page-upload')" class="btn-primary">撮影に進む</button>
            </div>
        </div>

        <!-- ===== Page 3: Upload ===== -->
        <div id="page-upload" class="page">
            <div class="card">
                <h2 class="text-xl font-bold text-center mb-2">写真・動画撮影</h2>
                <p class="text-center text-gray-500 mb-6">AI診断のため、指定されたアングルから撮影してください。</p>
                
                <div class="space-y-4 mb-6">
                    <!-- Front Image -->
                    <div id="upload-front" data-name="front_image" class="file-upload-container"></div>
                    <!-- Side Image -->
                    <div id="upload-side" data-name="side_image" class="file-upload-container"></div>
                    <!-- Back Image -->
                    <div id="upload-back" data-name="back_image" class="file-upload-container"></div>
                    <!-- Front Video -->
                    <div id="upload-video-front" data-name="front_video" class="file-upload-container"></div>
                    <!-- Back Video -->
                    <div id="upload-video-back" data-name="back_video" class="file-upload-container"></div>
                </div>
                
                <button id="start-diagnose-btn" onclick="startDiagnose()" class="btn-primary btn-disabled" disabled>AI診断をリクエストする</button>
            </div>
        </div>

        <!-- ===== Page 4: Loading ===== -->
        <div id="page-loading" class="page flex flex-col items-center justify-center min-h-[80vh]">
            <div class="card text-center">
                <div class="loader mx-auto mb-6"></div>
                <h2 class="text-xl font-bold">AIが診断中です</h2>
                <p class="text-gray-500">診断リクエストを送信中...</p>
            </div>
        </div>

        <!-- ===== Page 5: Results ===== -->
        <div id="page-results" class="page">
            <h2 class="text-2xl font-bold text-center my-6">AI診断結果</h2>
            <div id="diagnostics-output" class="space-y-6"></div>
            <div id="proposal-output" class="space-y-6 mt-6"></div>
            
            <div class="mt-8 grid grid-cols-1 gap-4">
                 <button onclick="shareResults()" class="btn-primary">結果をLINEで共有</button>
                 <button onclick="changePage('page-start')" class="btn-primary btn-secondary">トップに戻る</button>
            </div>
        </div>
        
        <!-- ===== Page 6: Virtual Try-on ===== -->
        <div id="page-tryon" class="page">
            <h2 class="text-2xl font-bold text-center my-6">バーチャル・トライオン</h2>
            <div class="card">
                <div class="relative mb-4">
                    <img id="tryon-image" src="https://placehold.co/400x400/F0FEFD/0ABAB5?text=Style+Image" alt="合成画像" class="w-full h-auto rounded-lg">
                    <div id="tryon-loading-overlay" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center rounded-lg" style="display: none;">
                        <div class="loader"></div>
                    </div>
                </div>

                <h3 class="font-bold text-lg mb-4">画像の微調整</h3>
                <p class="text-sm text-gray-500 mb-4">「もう少し明るく」「前髪を短く」など、ご要望を伝えて画像を調整できます。</p>
                <div class="flex items-center gap-2 mb-4">
                     <input type="text" id="adjustment-text" placeholder="例：もう少し髪を明るくして" class="w-full p-2 border rounded-full px-4">
                     <button class="w-10 h-10 bg-gray-200 rounded-full flex-shrink-0"><i class="fa-solid fa-microphone"></i></button>
                </div>
                <button onclick="regenerateStyle()" class="btn-primary mb-4">変更を反映する</button>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="saveAndShareImage()" class="btn-primary">この画像を保存して共有</button>
                    <button onclick="changePage('page-results')" class="btn-primary btn-secondary">診断結果に戻る</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // バックエンドサーバーのURL（重要：デプロイ後に書き換える必要があります）
        const API_BASE_URL = 'http://127.0.0.1:5001';
        // あなたのLIFF ID（重要：LINE Developersコンソールで取得したものに書き換えてください）
        const MY_LIFF_ID = "2008029428-DZNnAbNI";

        // グローバル変数
        let currentPage = 'page-start';
        const uploadedFiles = new Map();
        let diagnosisResultCache = null; // 診断結果をキャッシュ

        // ページの切り替え
        function changePage(pageId) {
            const currentPageEl = document.getElementById(currentPage);
            const nextPageEl = document.getElementById(pageId);
            if(currentPageEl) currentPageEl.classList.remove('active');
            if(nextPageEl) nextPageEl.classList.add('active');
            currentPage = pageId;
            window.scrollTo(0, 0);
        }
        
        function renderFileUploadBox(containerId, { icon, title, description, accept }) {
            const container = document.getElementById(containerId);
            const dataName = container.dataset.name;
            container.innerHTML = `
                <label for="${dataName}" class="file-upload-box flex items-center gap-4">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-xl text-gray-500 flex-shrink-0">
                        <i class="fa-solid ${icon}"></i>
                    </div>
                    <div class="text-left">
                        <p class="font-bold">${title}</p>
                        <p class="text-sm text-gray-500">${description}</p>
                    </div>
                    <div class="ml-auto">
                         <div id="preview-${dataName}" class="w-16 h-16 bg-gray-200 rounded-md overflow-hidden flex items-center justify-center">
                             <i class="fa-solid fa-plus text-gray-400"></i>
                         </div>
                    </div>
                </label>
                <input type="file" id="${dataName}" name="${dataName}" accept="${accept}" class="hidden" onchange="handleFileSelect(event)">
            `;
        }

        function handleFileSelect(event) {
            const input = event.target;
            const file = input.files[0];
            if (!file) return;

            uploadedFiles.set(input.name, file);

            const preview = document.getElementById(`preview-${input.name}`);
            const reader = new FileReader();
            reader.onload = e => {
                if (file.type.startsWith('image/')) {
                    preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                } else if (file.type.startsWith('video/')) {
                    preview.innerHTML = `<video src="${e.target.result}" class="w-full h-full object-cover" muted playsinline></video>`;
                }
            };
            reader.readAsDataURL(file);
            updateDiagnoseButtonState();
        }
        
        function updateDiagnoseButtonState() {
             const requiredFiles = ['front_image', 'side_image', 'back_image'];
             const allRequiredFilesUploaded = requiredFiles.every(name => uploadedFiles.has(name));
             const btn = document.getElementById('start-diagnose-btn');
             if (allRequiredFilesUploaded) {
                 btn.classList.remove('btn-disabled');
                 btn.disabled = false;
             } else {
                 btn.classList.add('btn-disabled');
                 btn.disabled = true;
             }
        }

        async function startDiagnose() {
            changePage('page-loading');
            const formData = new FormData();
            for (const [name, file] of uploadedFiles.entries()) {
                formData.append(name, file);
            }
            try {
                const response = await fetch(`${API_BASE_URL}/diagnose`, {
                    method: 'POST', body: formData,
                });
                if (!response.ok) throw new Error(`サーバーエラー: ${response.status}`);
                const result = await response.json();
                diagnosisResultCache = result; // 結果をキャッシュ
                displayResults(result);
                changePage('page-results');
            } catch (error) {
                console.error('診断エラー:', error);
                alert('診断に失敗しました。もう一度お試しください。');
                changePage('page-upload');
            }
        }

        function displayResults(result) {
            const diagnosticsOutput = document.getElementById('diagnostics-output');
            const proposalOutput = document.getElementById('proposal-output');
            diagnosticsOutput.innerHTML = '';
            proposalOutput.innerHTML = '';
            
            const { diagnostics, proposal } = result;

            const renderDiagnosisCard = (title, icon, data) => {
                let items = Object.entries(data).map(([key, value]) => `
                    <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                        <span class="text-gray-600">${key}</span>
                        <span class="font-bold text-right">${value}</span>
                    </div>`).join('');
                return `<div class="card"><h3 class="font-bold text-lg mb-3 flex items-center gap-2 text-teal-600"><i class="fa-solid ${icon}"></i> ${title}</h3><div class="text-sm">${items}</div></div>`;
            };

            diagnosticsOutput.innerHTML += renderDiagnosisCard('顔診断', 'fa-face-smile', diagnostics.face_diagnosis);
            diagnosticsOutput.innerHTML += renderDiagnosisCard('骨格診断', 'fa-person', diagnostics.skeleton_diagnosis);
            diagnosticsOutput.innerHTML += renderDiagnosisCard('パーソナルカラー診断', 'fa-palette', diagnostics.personal_color_diagnosis);
            diagnosticsOutput.innerHTML += renderDiagnosisCard('毛髪診断', 'fa-wind', diagnostics.hair_diagnosis);

            let proposalHtml = '';
            const renderProposalCard = (title, icon, items, isTryon = false) => {
                let itemHtml = items.map((item, index) => {
                    const buttonHtml = isTryon 
                        ? `<button onclick="startTryon('${item.name}')" class="mt-2 text-xs font-bold text-teal-600 hover:underline">このスタイルを試す <i class="fa-solid fa-arrow-right"></i></button>` : '';
                    return `<div class="card bg-teal-50 flex-1 min-w-[120px]"><p class="font-bold text-teal-700">${isTryon ? 'Style' : 'Color'} ${index + 1}</p><p class="text-lg font-bold mb-1">${item.name}</p><p class="text-xs text-gray-600">${item.description}</p>${buttonHtml}</div>`;
                }).join('');
                return `<div><h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i class="fa-solid ${icon} text-teal-600"></i> ${title}</h3><div class="flex flex-col sm:flex-row gap-4">${itemHtml}</div></div>`;
            };
            
            proposalHtml += renderProposalCard('ヘアスタイル提案', 'fa-scissors', proposal.hairstyle_proposal, true);
            proposalHtml += renderProposalCard('ヘアカラー提案', 'fa-brush', proposal.haircolor_proposal);
            proposalHtml += `<div class="card"><h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i class="fa-solid fa-star text-teal-600"></i> トップスタイリストAIより</h3><p class="text-gray-600 leading-relaxed">${proposal.final_comment}</p></div>`;
            proposalOutput.innerHTML = proposalHtml;
        }

        let currentTryonStyle = '';
        function startTryon(styleName) {
            currentTryonStyle = styleName;
            document.getElementById('tryon-image').src = "https://placehold.co/400x400/F0FEFD/0ABAB5?text=Generating...";
            document.getElementById('adjustment-text').value = '';
            changePage('page-tryon');
            generateStyleImage();
        }
        
        function regenerateStyle() {
            const extraPrompt = document.getElementById('adjustment-text').value;
            generateStyleImage(extraPrompt);
        }

        async function generateStyleImage(extraPrompt = '') {
            const loadingOverlay = document.getElementById('tryon-loading-overlay');
            loadingOverlay.style.display = 'flex';
            
            const formData = new FormData();
            formData.append('front_image', uploadedFiles.get('front_image'));
            formData.append('style_text', currentTryonStyle);
if (extraPrompt) formData.append('text_prompt', extraPrompt);

            try {
                const response = await fetch(`${API_BASE_URL}/generate_style`, {
                    method: 'POST', body: formData,
                });
                if (!response.ok) throw new Error('画像生成に失敗');
                const imageBlob = await response.blob();
                document.getElementById('tryon-image').src = URL.createObjectURL(imageBlob);
            } catch (error) {
                console.error('画像生成エラー:', error);
                alert('画像生成に失敗しました。');
                document.getElementById('tryon-image').src = "https://placehold.co/400x400/F0FEFD/FF0000?text=Error";
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        async function initializeLiff() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                document.getElementById('user-id').value = profile.userId;
                document.getElementById('user-name').value = profile.displayName;
            } catch (error) {
                console.error("LIFFの初期化に失敗しました", error);
                alert("LIFFの初期化に失敗しました。LINE環境で開いているか確認してください。");
            }
        }
        
        // 結果をLINEで共有する（Flex Messageを想定）
        function shareResults() {
             if (!liff.isInClient()) {
                alert("この機能はLINEアプリ内でのみ利用可能です。");
                return;
             }
             if (!diagnosisResultCache) {
                alert("診断結果がありません。");
                return;
             }
             // ここにFlex Messageを組み立ててliff.shareTargetPicker()で送信する処理を実装
             alert("共有機能は現在開発中です。");
        }
        
        // 画像を共有する
        function saveAndShareImage() {
            alert("画像保存・共有機能は現在開発中です。");
        }
        
        // 初期化処理
        document.addEventListener('DOMContentLoaded', () => {
            initializeLiff(); // LIFFの初期化
            
            renderFileUploadBox('upload-front', {icon: 'fa-camera', title: '写真：正面', description: '顔がはっきり写るように', accept: 'image/*'});
            renderFileUploadBox('upload-side', {icon: 'fa-camera', title: '写真：サイド', description: '横顔と髪の長さがわかるように', accept: 'image/*'});
            renderFileUploadBox('upload-back', {icon: 'fa-camera', title: '写真：バック', description: '後ろ全体の髪型がわかるように', accept: 'image/*'});
            renderFileUploadBox('upload-video-front', {icon: 'fa-video', title: '動画：正面 (3秒)', description: 'ゆっくりと左右に顔を動かす', accept: 'video/*'});
            renderFileUploadBox('upload-video-back', {icon: 'fa-video', title: '動画：バック (3秒)', description: '髪全体の動きがわかるように', accept: 'video/*'});
            
            updateDiagnoseButtonState();
        });

    </script>
</body>
</html>

