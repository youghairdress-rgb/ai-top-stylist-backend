<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIトップスタイリスト診断</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #0ABAB5; /* ティファニーブルー系 */
            --background-color: #F0FDFB;
            --text-color: #333;
            --card-background: #ffffff;
            --button-text-color: #ffffff;
            --button-hover-color: #089A95;
        }
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .main-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--card-background);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        .card {
            background-color: var(--card-background);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            transition: background-color 0.3s ease;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
        }
        .btn-primary:hover {
            background-color: var(--button-hover-color);
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
        }
        /* スピナーアニメーション */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="main-container">
        <!-- 各画面をここに定義 -->
        <div id="screen-start" class="p-6 text-center flex flex-col items-center justify-center min-h-[80vh]">
            <div class="w-32 h-32 bg-teal-100 rounded-full flex items-center justify-center mb-6">
                <span class="text-2xl font-bold text-teal-600">LOGO</span>
            </div>
            <h1 class="text-2xl font-bold mb-2">YHD AI Diagnosis</h1>
            <p class="text-gray-600 mb-8">お客様の『似合う』を実現するために<br>AIが分析し、最適なアドバイスを伝えます！</p>
            <button onclick="showScreen('screen-profile')" class="btn-primary w-full">診断を始める</button>
        </div>

        <div id="screen-profile" class="hidden p-6">
            <h2 class="text-2xl font-bold text-center mb-8">プロフィール入力</h2>
            <div class="space-y-6">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">お名前</label>
                    <input type="text" id="name" value="テストユーザー" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">性別</label>
                    <div class="mt-2 flex space-x-4">
                        <label><input type="radio" name="gender" value="female" class="focus:ring-teal-500 h-4 w-4 text-teal-600 border-gray-300"> 女性</label>
                        <label><input type="radio" name="gender" value="male" class="focus:ring-teal-500 h-4 w-4 text-teal-600 border-gray-300"> 男性</label>
                        <label><input type="radio" name="gender" value="other" class="focus:ring-teal-500 h-4 w-4 text-teal-600 border-gray-300"> その他</label>
                    </div>
                </div>
                <button onclick="showScreen('screen-upload')" class="btn-primary w-full !mt-10">撮影に進む</button>
            </div>
        </div>

        <div id="screen-upload" class="hidden p-6">
            <h2 class="text-2xl font-bold text-center mb-8">写真・動画撮影</h2>
            <p class="text-center text-gray-600 mb-6">AI診断のため、指定されたアングルから撮影してください。</p>
            <div class="space-y-4">
                <!-- 正面写真 -->
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-semibold">写真：正面</p>
                        <p class="text-sm text-gray-500">顔がはっきり写るように</p>
                    </div>
                    <input type="file" id="front_image" accept="image/*" class="hidden">
                    <button onclick="document.getElementById('front_image').click()" class="btn-secondary text-sm">撮影する</button>
                </div>
                <!-- 側面写真 -->
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-semibold">写真：サイド (任意)</p>
                        <p class="text-sm text-gray-500">横顔と髪の長さがわかるように</p>
                    </div>
                    <input type="file" id="side_image" accept="image/*" class="hidden">
                    <button onclick="document.getElementById('side_image').click()" class="btn-secondary text-sm">撮影する</button>
                </div>
                 <!-- 背面写真 -->
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-semibold">写真：バック (任意)</p>
                        <p class="text-sm text-gray-500">後ろ全体の髪型がわかるように</p>
                    </div>
                    <input type="file" id="back_image" accept="image/*" class="hidden">
                    <button onclick="document.getElementById('back_image').click()" class="btn-secondary text-sm">撮影する</button>
                </div>
            </div>
            <button onclick="startDiagnosis()" class="btn-primary w-full mt-10">AI診断をリクエストする</button>
        </div>

        <div id="screen-loading" class="hidden p-6 text-center flex flex-col items-center justify-center min-h-[80vh]">
            <div class="spinner mb-6"></div>
            <h2 class="text-xl font-semibold">AIが診断中です</h2>
            <p class="text-gray-500">診断リクエストを送信中...</p>
        </div>
        
        <div id="screen-results" class="hidden p-6 space-y-6">
            <h2 class="text-2xl font-bold text-center">AI診断結果</h2>
            <div id="diagnosis-output"></div>
            <div id="proposals-output"></div>
            <button onclick="showScreen('screen-start')" class="btn-secondary w-full">トップに戻る</button>
        </div>

    </div>

    <script>
        // バックエンドサーバーのURL
        const API_BASE_URL = 'https://ai-top-stylist-backend.onrender.com';

        // 画面切り替え関数
        function showScreen(screenId) {
            document.querySelectorAll('.main-container > div').forEach(div => {
                div.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // 診断開始処理
        async function startDiagnosis() {
            const frontImageFile = document.getElementById('front_image').files[0];
            
            if (!frontImageFile) {
                alert('正面の写真をアップロードしてください。');
                return;
            }

            showScreen('screen-loading');

            const formData = new FormData();
            formData.append('front_image', frontImageFile);
            // 将来的には他の画像も追加
            // formData.append('side_image', document.getElementById('side_image').files[0]);
            // formData.append('back_image', document.getElementById('back_image').files[0]);

            try {
                const response = await fetch(`${API_BASE_URL}/diagnose`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`サーバーエラー: ${response.status}`);
                }
                
                const result = await response.json();
                displayResults(result);

            } catch (error) {
                console.error('診断中にエラーが発生しました:', error);
                alert('診断中にエラーが発生しました。サーバーが混み合っている可能性があります。');
                showScreen('screen-upload'); // エラー時はアップロード画面に戻る
            }
        }
        
        // 結果表示処理
        function displayResults(result) {
            const diagnosisOutput = document.getElementById('diagnosis-output');
            const proposalsOutput = document.getElementById('proposals-output');
            
            diagnosisOutput.innerHTML = '';
            proposalsOutput.innerHTML = '';

            // 診断結果の表示
            if(result.diagnosis) {
                let diagnosisHtml = '<div class="card space-y-4">';
                for (const [category, details] of Object.entries(result.diagnosis)) {
                    const categoryName = category.replace('_diagnosis', '').replace('face', '顔').replace('skeleton', '骨格').replace('personal_color', 'パーソナルカラー');
                    diagnosisHtml += `<h3 class="text-lg font-semibold text-teal-600">${categoryName}診断</h3>`;
                    diagnosisHtml += '<dl class="divide-y divide-gray-100">';
                    for (const [key, value] of Object.entries(details)) {
                        diagnosisHtml += `<div class="px-2 py-2 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">${key}</dt><dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0 font-semibold">${value}</dd></div>`;
                    }
                    diagnosisHtml += '</dl>';
                }
                diagnosisHtml += '</div>';
                diagnosisOutput.innerHTML = diagnosisHtml;
            }

            // 提案の表示
            if(result.proposals) {
                 let proposalsHtml = '<div class="space-y-6">';

                // ヘアスタイル提案
                proposalsHtml += '<h3 class="text-lg font-semibold text-teal-600 mt-6">ヘアスタイル提案</h3><div class="grid grid-cols-2 gap-4">';
                result.proposals.hairstyles.forEach(style => {
                    proposalsHtml += `<div class="p-4 border rounded-lg bg-orange-50"><p class="font-bold text-orange-700">${style.name}</p><p class="text-sm text-gray-600">${style.description}</p></div>`;
                });
                proposalsHtml += '</div>';

                // ヘアカラー提案
                proposalsHtml += '<h3 class="text-lg font-semibold text-teal-600 mt-6">ヘアカラー提案</h3><div class="grid grid-cols-2 gap-4">';
                result.proposals.hair_colors.forEach(color => {
                    proposalsHtml += `<div class="p-4 border rounded-lg bg-teal-50"><p class="font-bold text-teal-700">${color.name}</p><p class="text-sm text-gray-600">${color.description}</p></div>`;
                });
                proposalsHtml += '</div>';
                
                // トップスタイリストからの総評
                proposalsHtml += '<h3 class="text-lg font-semibold text-teal-600 mt-6">トップスタイリストAIより</h3>';
                proposalsHtml += `<div class="p-4 border rounded-lg bg-gray-50"><p class="text-sm text-gray-800">${result.proposals.top_stylist_comment}</p></div>`;

                proposalsHtml += '</div>';
                proposalsOutput.innerHTML = proposalsHtml;
            }
            
            showScreen('screen-results');
        }

        // 初期画面を表示
        showScreen('screen-start');
    </script>
</body>
</html>

