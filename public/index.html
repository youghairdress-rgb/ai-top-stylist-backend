<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIトップスタイリスト診断</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #0ABAB5; /* ティファニーブルー系 */
            --background-color: #F0FDFB;
            --text-color: #333;
            --card-background: #ffffff;
            --button-text-color: #ffffff;
            --button-hover-color: #089A95;
            --dark-button-color: #374151;
            --dark-button-hover-color: #4b5563;
        }
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .main-container {
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .screen-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 2.5rem 1.5rem;
            background-color: white;
            border-radius: 2rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            margin: 1rem;
            min-height: calc(100vh - 2rem);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            transition: background-color 0.3s ease;
            border-radius: 9999px;
            padding: 1rem 1.5rem;
            font-weight: 600;
            width: 100%;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary:hover {
            background-color: var(--button-hover-color);
        }
        .btn-dark {
            background-color: var(--dark-button-color);
            color: var(--button-text-color);
            transition: background-color 0.3s ease;
            border-radius: 9999px;
            padding: 1rem 1.5rem;
            font-weight: 600;
            width: 100%;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-dark:hover {
             background-color: var(--dark-button-hover-color);
        }
        .btn-outline {
            background-color: transparent;
            color: #6b7280;
            border: 1px solid #d1d5db;
            transition: all 0.3s ease;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
        }
        /* Spinner Animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center">

    <div class="main-container">
        <!-- Screen: Start -->
        <div id="screen-start" class="screen-content text-center items-center">
            <div class="w-36 h-36 bg-teal-100 rounded-full flex items-center justify-center mb-8">
                <span class="text-3xl font-bold text-teal-600">LOGO</span>
            </div>
            <h1 class="text-3xl font-bold mb-3">YHD AI Diagnosis</h1>
            <p class="text-gray-500 mb-10 text-base">お客様の『似合う』を実現するために<br>AIが分析し、最適なアドバイスを伝えます！</p>
            <button onclick="showScreen('screen-profile')" class="btn-primary">診断を始める</button>
        </div>

        <!-- Screen: Profile -->
        <div id="screen-profile" class="hidden screen-content">
            <h2 class="text-2xl font-bold text-center mb-8">プロフィール入力</h2>
            <div class="space-y-6">
                 <div>
                    <label for="line-id" class="block text-sm font-medium text-gray-700 mb-1">LINEユーザーID</label>
                    <input type="text" id="line-id" readonly class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-500" value="(LIFFから自動取得)">
                </div>
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">お名前</label>
                    <input type="text" id="name" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-teal-500 focus:border-teal-500" placeholder="例：山田 花子">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">性別</label>
                    <div class="flex justify-around p-1 bg-gray-100 rounded-full">
                        <label class="w-full text-center"><input type="radio" name="gender" value="female" class="sr-only peer" checked><span class="block w-full py-2 px-4 rounded-full cursor-pointer peer-checked:bg-white peer-checked:shadow">女性</span></label>
                        <label class="w-full text-center"><input type="radio" name="gender" value="male" class="sr-only peer"><span class="block w-full py-2 px-4 rounded-full cursor-pointer peer-checked:bg-white peer-checked:shadow">男性</span></label>
                        <label class="w-full text-center"><input type="radio" name="gender" value="other" class="sr-only peer"><span class="block w-full py-2 px-4 rounded-full cursor-pointer peer-checked:bg-white peer-checked:shadow">その他</span></label>
                    </div>
                </div>
                <button onclick="showScreen('screen-upload')" class="btn-dark w-full !mt-12">撮影に進む</button>
            </div>
        </div>
        
        <!-- Screen: Upload -->
        <div id="screen-upload" class="hidden screen-content">
            <h2 class="text-2xl font-bold text-center mb-2">写真撮影</h2>
            <p class="text-center text-gray-500 mb-8">AI診断のため、正面から顔がはっきり写る写真を1枚撮影してください。</p>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                    <div class="flex items-center space-x-4">
                         <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <div>
                            <p class="font-semibold">写真：正面</p>
                            <p class="text-sm text-gray-500">顔がはっきり写るように</p>
                        </div>
                    </div>
                    <input type="file" id="front_image" accept="image/*" class="hidden">
                    <button id="upload-button" onclick="document.getElementById('front_image').click()" class="btn-outline">撮影する</button>
                </div>
            </div>
            <button id="start-diagnosis-btn" onclick="startDiagnosis()" class="btn-dark w-full !mt-12">AI診断をリクエストする</button>
             <button onclick="showScreen('screen-profile')" class="w-full text-center text-gray-500 mt-4 text-sm">戻る</button>
        </div>

        <!-- Screen: Loading -->
        <div id="screen-loading" class="hidden screen-content text-center items-center">
            <div class="spinner mb-8"></div>
            <h2 class="text-xl font-semibold">AIが診断中です</h2>
            <p class="text-gray-500">結果を取得しています... (最大2分程度)</p>
        </div>
        
        <!-- Screen: Results -->
        <div id="screen-results" class="hidden p-4 md:p-6 space-y-6 overflow-y-auto">
            <h2 class="text-2xl font-bold text-center pt-8">AI診断結果</h2>
            <div id="diagnosis-output"></div>
            <div id="proposals-output"></div>
            <div class="p-4 sticky bottom-4 bg-white/80 backdrop-blur-sm rounded-2xl">
                 <button onclick="showScreen('screen-start')" class="btn-primary w-full">トップに戻る</button>
            </div>
        </div>
    </div>

    <script>
        // バックエンドAPIのURLを設定します。
        // ローカルでのテスト用: 'http://127.0.0.1:8080'
        // Render.comデプロイ後: 'https://your-app-name.onrender.com'
        const API_BASE_URL = 'https://ai-top-stylist-backend.onrender.com';

        function showScreen(screenId) {
            document.querySelectorAll('.main-container > div').forEach(div => {
                div.classList.add('hidden');
            });
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.remove('hidden');
            }
        }

        document.getElementById('front_image').addEventListener('change', function(event) {
            const uploadButton = document.getElementById('upload-button');
            if (event.target.files.length > 0) {
                uploadButton.textContent = '変更する';
                uploadButton.classList.remove('btn-outline');
                uploadButton.classList.add('bg-gray-200');
            }
        });

        async function startDiagnosis() {
            const frontImageFile = document.getElementById('front_image').files[0];
            const startButton = document.getElementById('start-diagnosis-btn');
            
            if (!frontImageFile) {
                alert('診断を開始するには、正面の写真をアップロードしてください。');
                return;
            }

            // 処理中にボタンを無効化
            startButton.disabled = true;
            startButton.textContent = '診断中...';
            showScreen('screen-loading');

            const formData = new FormData();
            formData.append('front_image', frontImageFile);

            try {
                const response = await fetch(`${API_BASE_URL}/diagnose`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    // サーバーからエラーレスポンスが返された場合、JSONからエラーメッセージを抽出
                    const errorData = await response.json().catch(() => ({ error: 'サーバーから不明な形式のエラーが返されました。' }));
                    throw new Error(`サーバーエラー (コード: ${response.status}): ${errorData.error || '詳細不明'}`);
                }
                
                const result = await response.json();
                console.log("Received data from backend:", result);
                displayResults(result);

            } catch (error) {
                console.error('診断リクエスト中に重大なエラーが発生しました:', error);
                // ユーザーに分かりやすいエラーメッセージを表示
                alert('診断中にエラーが発生しました。\n\n詳細: ' + error.message + '\n\nしばらくしてからもう一度お試しください。');
                showScreen('screen-upload'); 
            } finally {
                // 処理が完了したら（成功・失敗問わず）、ボタンの状態を元に戻す
                startButton.disabled = false;
                startButton.textContent = 'AI診断をリクエストする';
            }
        }
        
        function displayResults(result) {
            const diagnosisOutput = document.getElementById('diagnosis-output');
            const proposalsOutput = document.getElementById('proposals-output');
            diagnosisOutput.innerHTML = '';
            proposalsOutput.innerHTML = '';

            // 診断結果の表示
            if(result && result.diagnosis) {
                let diagnosisHtml = '<div class="space-y-6">';
                for (const [category, details] of Object.entries(result.diagnosis)) {
                     const categoryInfo = {
                        'face_diagnosis': { name: '顔診断', icon: '🙂' },
                        'skeleton_diagnosis': { name: '骨格診断', icon: '🧍' },
                        'personal_color_diagnosis': { name: 'パーソナルカラー診断', icon: '🎨' }
                    }[category] || { name: '診断結果', icon: '✨' };
                    
                    diagnosisHtml += `<div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-100">
                                        <h3 class="text-lg font-semibold text-gray-800 mb-4">${categoryInfo.icon} ${categoryInfo.name}</h3>
                                        <dl class="divide-y divide-gray-200">`;
                    for (const [key, value] of Object.entries(details)) {
                        diagnosisHtml += `<div class="py-3 grid grid-cols-3 gap-4"><dt class="text-sm text-gray-500">${key}</dt><dd class="text-sm text-gray-900 col-span-2 font-medium">${value}</dd></div>`;
                    }
                    diagnosisHtml += `</dl></div>`;
                }
                diagnosisHtml += '</div>';
                diagnosisOutput.innerHTML = diagnosisHtml;
            }

            // 提案結果の表示
            if(result && result.proposals) {
                 let proposalsHtml = '<div class="space-y-8 mt-8">';
                
                // ヘアスタイル提案
                proposalsHtml += '<div><h3 class="text-xl font-bold text-gray-800 mb-4">✂️ ヘアスタイル提案</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                result.proposals.hairstyles.forEach(style => {
                    proposalsHtml += `<div class="p-4 rounded-xl bg-orange-50 border border-orange-200"><p class="font-bold text-orange-800">${style.name}</p><p class="text-sm text-gray-600 mt-1">${style.description}</p></div>`;
                });
                proposalsHtml += '</div></div>';
                
                // ヘアカラー提案
                proposalsHtml += '<div><h3 class="text-xl font-bold text-gray-800 mb-4">🌈 ヘアカラー提案</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                result.proposals.hair_colors.forEach(color => {
                    proposalsHtml += `<div class="p-4 rounded-xl bg-teal-50 border border-teal-200"><p class="font-bold text-teal-800">${color.name}</p><p class="text-sm text-gray-600 mt-1">${color.description}</p></div>`;
                });
                proposalsHtml += '</div></div>';
                
                // AI総評
                proposalsHtml += '<div><h3 class="text-xl font-bold text-gray-800 mb-4">✨ トップスタイリストAIより</h3>';
                proposalsHtml += `<div class="p-6 rounded-2xl bg-gray-50 border border-gray-200"><p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">${result.proposals.top_stylist_comment}</p></div></div>`;
                
                proposalsHtml += '</div>';
                proposalsOutput.innerHTML = proposalsHtml;
            }
            
            showScreen('screen-results');
        }
        
        // 初期画面を表示
        showScreen('screen-start');
    </script>
</body>
</html>
